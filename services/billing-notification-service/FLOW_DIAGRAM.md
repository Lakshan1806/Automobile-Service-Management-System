# Enhanced Notification Flow Diagram

## Complete Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MICROSERVICES LAYER                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Technician   â”‚  â”‚  Customer    â”‚  â”‚   Manager    â”‚         â”‚
â”‚  â”‚  Service     â”‚  â”‚  Service     â”‚  â”‚   Service    â”‚         â”‚
â”‚  â”‚  (Node.js)   â”‚  â”‚   (C#)       â”‚  â”‚  (Node.js)   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                 â”‚                 â”‚                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                           â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          BILLING & NOTIFICATION SERVICE (Django)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         STEP 1: GENERATE BILL (Unchanged)                â”‚  â”‚
â”‚  â”‚  POST /api/notification/bill/generate/                   â”‚  â”‚
â”‚  â”‚  {                                                        â”‚  â”‚
â”‚  â”‚    "customer_email": "customer@example.com",            â”‚  â”‚
â”‚  â”‚    "service_id": "uuid",                                 â”‚  â”‚
â”‚  â”‚    "products": [                                         â”‚  â”‚
â”‚  â”‚      {"product_id": "uuid", "quantity": 2}              â”‚  â”‚
â”‚  â”‚    ]                                                     â”‚  â”‚
â”‚  â”‚  }                                                        â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â†“ Fetches Service.estimated_cost from admin_service    â”‚  â”‚
â”‚  â”‚  â†“ Fetches Part.unit_price for each product             â”‚  â”‚
â”‚  â”‚  â†“ Calculates: total = service_cost + Î£(part Ã— qty)     â”‚  â”‚
â”‚  â”‚  â†“ Creates Bill & BillItem records                       â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  Response: {                                             â”‚  â”‚
â”‚  â”‚    "bill_id": "abc-123-uuid",                           â”‚  â”‚
â”‚  â”‚    "total_price": "225.00",                             â”‚  â”‚
â”‚  â”‚    "items": [...]                                        â”‚  â”‚
â”‚  â”‚  }                                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                     â”‚
â”‚                           â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         STEP 2: SEND NOTIFICATION (Enhanced)             â”‚  â”‚
â”‚  â”‚  POST /api/notification/send/                            â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  Three Options:                                          â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚  Option A: Simple Text (OTP, Alerts)           â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  {                                               â”‚    â”‚  â”‚
â”‚  â”‚  â”‚    "to": "customer@example.com",                â”‚    â”‚  â”‚
â”‚  â”‚  â”‚    "subject": "Your OTP",                       â”‚    â”‚  â”‚
â”‚  â”‚  â”‚    "body": "Your OTP is: 123456"                â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  }                                               â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚  Option B: Bill Details in Body                 â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  {                                               â”‚    â”‚  â”‚
â”‚  â”‚  â”‚    "to": "customer@example.com",                â”‚    â”‚  â”‚
â”‚  â”‚  â”‚    "subject": "Your Invoice",                   â”‚    â”‚  â”‚
â”‚  â”‚  â”‚    "body": "â”â”â”â”â”â”â”â”â”â”\nINVOICE\nâ”â”â”â”â”â”â”â”â”â”\nâ”‚    â”‚  â”‚
â”‚  â”‚  â”‚             Oil Change: $120\n                  â”‚    â”‚  â”‚
â”‚  â”‚  â”‚             Total: $225\nâ”â”â”â”â”â”â”â”â”â”",         â”‚    â”‚  â”‚
â”‚  â”‚  â”‚    "is_html": false                             â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  }                                               â”‚    â”‚  â”‚
â”‚  â”‚  â”‚                                                  â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  OR with HTML:                                  â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  {                                               â”‚    â”‚  â”‚
â”‚  â”‚  â”‚    "body": "<html>...formatted bill...</html>", â”‚    â”‚  â”‚
â”‚  â”‚  â”‚    "is_html": true                              â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  }                                               â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚  Option C: Bill with PDF Attachment (NEW)       â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  {                                               â”‚    â”‚  â”‚
â”‚  â”‚  â”‚    "to": "customer@example.com",                â”‚    â”‚  â”‚
â”‚  â”‚  â”‚    "subject": "Your Invoice with PDF",          â”‚    â”‚  â”‚
â”‚  â”‚  â”‚    "body": "Your invoice is attached.",         â”‚    â”‚  â”‚
â”‚  â”‚  â”‚    "bill_id": "abc-123-uuid",                   â”‚    â”‚  â”‚
â”‚  â”‚  â”‚    "attach_invoice": true                       â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  }                                               â”‚    â”‚  â”‚
â”‚  â”‚  â”‚                                                  â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â†“ Retrieves Bill from database                 â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â†“ Generates PDF using ReportLab                â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  â†“ Attaches PDF to email                        â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                     â”‚
â”‚                           â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚             EMAIL SERVICE (SMTP)                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚  Simple Text Email                              â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  - Plain text body                              â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  - No attachments                               â”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚  HTML Email                                     â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  - HTML body with formatting                    â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  - Plain text fallback                          â”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚  â”‚  Email with PDF                                 â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  - Body message                                 â”‚     â”‚  â”‚
â”‚  â”‚  â”‚  - PDF invoice attached                         â”‚     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CUSTOMER EMAIL                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  From: automobile-service@example.com                   â”‚   â”‚
â”‚  â”‚  To: customer@example.com                               â”‚   â”‚
â”‚  â”‚  Subject: Service Invoice #abc-123                      â”‚   â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  [Email Body - OTP, Bill Details, or Message]           â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚  ğŸ“ Attachments (if requested):                         â”‚   â”‚
â”‚  â”‚     invoice_abc-123.pdf (45 KB)                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Decision Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Need to send a notification?       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  What type?  â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
       â”‚               â”‚
    OTP/Alert      Bill/Invoice
       â”‚               â”‚
       â”‚               â–¼
       â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚      â”‚  Customer needs â”‚
       â”‚      â”‚  PDF for        â”‚
       â”‚      â”‚  records?       â”‚
       â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
       â”‚           â”‚       â”‚
       â”‚          Yes     No
       â”‚           â”‚       â”‚
       â”‚           â”‚       â–¼
       â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚           â”‚  â”‚ Quick email  â”‚
       â”‚           â”‚  â”‚ view better? â”‚
       â”‚           â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
       â”‚           â”‚      â”‚      â”‚
       â”‚           â”‚     Yes    No
       â”‚           â”‚      â”‚      â”‚
       â”‚           â”‚      â”‚      â–¼
       â–¼           â–¼      â–¼      Skip
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” notification
   â”‚ Simple â”‚  â”‚ PDF â”‚ â”‚ Body â”‚
   â”‚  body  â”‚  â”‚ att â”‚ â”‚ HTML â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”˜
        â”‚         â”‚        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ POST /api/     â”‚
         â”‚ notification/  â”‚
         â”‚ send/          â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Code Flow in SendNotificationView

```python
def post(self, request):
    # 1. Validate request
    serializer = SendNotificationSerializer(data=request.data)
    if not serializer.is_valid():
        return 400 error
    
    # 2. Extract data
    to = serializer.validated_data['to']
    subject = serializer.validated_data['subject']
    body = serializer.validated_data['body']
    is_html = serializer.validated_data.get('is_html', False)
    bill_id = serializer.validated_data.get('bill_id')
    attach_invoice = serializer.validated_data.get('attach_invoice', False)
    
    # 3. Check if PDF should be attached
    if attach_invoice and bill_id:
        # Path A: Email with PDF attachment
        try:
            # Get bill from database
            bill = Bill.objects.get(bill_id=bill_id)
            
            # Generate PDF in memory
            pdf_buffer = BillService.generate_bill_pdf(bill)
            
            # Create email with attachment
            email = EmailMultiAlternatives(...)
            if is_html:
                email.attach_alternative(body, "text/html")
            email.attach('invoice.pdf', pdf_buffer.getvalue(), 'application/pdf')
            email.send()
            
            return {
                'success': True,
                'invoice_attached': True,
                'bill_id': bill_id
            }
        except Bill.DoesNotExist:
            return 404 error
    else:
        # Path B: Regular email (no PDF)
        if is_html:
            # HTML email
            email = EmailMultiAlternatives(...)
            email.attach_alternative(body, "text/html")
            email.send()
        else:
            # Plain text email
            send_mail(...)
        
        return {
            'success': True
        }
```

---

## Database Schema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  admin_service_service      â”‚
â”‚  (pricing data)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  service_id (PK)            â”‚
â”‚  estimated_cost             â”‚â—„â”€â”€â”
â”‚  ...                        â”‚   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  admin_service_part         â”‚   â”‚
â”‚  (product pricing)          â”‚   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  part_id (PK)               â”‚â—„â”€â”€â”¤â”€â”
â”‚  unit_price                 â”‚   â”‚ â”‚
â”‚  ...                        â”‚   â”‚ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
                                   â”‚ â”‚
                           Fetches â”‚ â”‚ Fetches
                            prices â”‚ â”‚ prices
                                   â”‚ â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  notification_service_bill  â”‚   â”‚ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚ â”‚
â”‚  bill_id (PK)               â”‚   â”‚ â”‚
â”‚  customer_email             â”‚   â”‚ â”‚
â”‚  total_price                â”‚â”€â”€â”€â”˜ â”‚
â”‚  created_at                 â”‚     â”‚
â”‚  pdf_path                   â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
           â”‚                        â”‚
           â”‚ M:M                    â”‚
           â”‚                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  notification_service_      â”‚     â”‚
â”‚  billitem                   â”‚     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤     â”‚
â”‚  id (PK)                    â”‚     â”‚
â”‚  name                       â”‚â”€â”€â”€â”€â”€â”˜
â”‚  price                      â”‚
â”‚  quantity                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Integration Example (Technician Service)

```javascript
// technician-service/src/controllers/serviceController.js

async function completeService(req, res) {
  const { serviceId, customerId, partsUsed } = req.body;
  
  try {
    // 1. Mark service as complete in local DB
    await Service.update(serviceId, { status: 'completed' });
    
    // 2. Get customer email
    const customer = await Customer.findById(customerId);
    
    // 3. Generate bill via notification service
    const billResponse = await axios.post(
      'http://127.0.0.1:8000/api/notification/bill/generate/',
      {
        customer_email: customer.email,
        service_id: serviceId,
        products: partsUsed // [{ product_id, quantity }]
      }
    );
    
    const { bill_id, total_price, items } = billResponse.data;
    
    // 4. Decide how to send notification
    const sendWithPDF = customer.preferences.pdf_invoice === true;
    
    if (sendWithPDF) {
      // Option A: Send with PDF attachment
      await axios.post(
        'http://127.0.0.1:8000/api/notification/send/',
        {
          to: customer.email,
          subject: `Service Invoice #${bill_id}`,
          body: `Dear ${customer.name},\n\nYour vehicle service is complete.\n\nTotal: $${total_price}\n\nInvoice attached.`,
          bill_id: bill_id,
          attach_invoice: true
        }
      );
    } else {
      // Option B: Send bill details in body
      const billDetails = formatBillForEmail(bill_id, total_price, items);
      
      await axios.post(
        'http://127.0.0.1:8000/api/notification/send/',
        {
          to: customer.email,
          subject: `Service Invoice #${bill_id}`,
          body: billDetails,
          is_html: false
        }
      );
    }
    
    res.json({ success: true, bill_id });
    
  } catch (error) {
    console.error('Error completing service:', error);
    res.status(500).json({ error: 'Failed to complete service' });
  }
}

function formatBillForEmail(billId, total, items) {
  let text = `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    SERVICE INVOICE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Invoice ID: ${billId}
Date: ${new Date().toLocaleString()}

ITEMS:
`;
  
  items.forEach(item => {
    text += `\n${item.name}\n`;
    text += `  $${item.price} Ã— ${item.quantity} = $${item.total}\n`;
  });
  
  text += `\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  text += `TOTAL: $${total}\n`;
  text += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  
  return text;
}
```

---

## File Structure

```
billing-notification-service/
â”œâ”€â”€ notification_service/
â”‚   â”œâ”€â”€ models.py               # Bill, BillItem, OTP models
â”‚   â”œâ”€â”€ serializers.py          # âœ¨ Enhanced with bill_id, attach_invoice
â”‚   â”œâ”€â”€ views.py                # âœ¨ Enhanced SendNotificationView
â”‚   â”œâ”€â”€ urls.py                 # Routes (unchanged)
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ __init__.py         # âœ¨ Exports formatting functions
â”‚       â”œâ”€â”€ bill_service.py     # PDF generation (unchanged)
â”‚       â”œâ”€â”€ bill_formatter.py   # âœ¨ NEW: Text & HTML formatters
â”‚       â”œâ”€â”€ email_service.py    # Email sending (unchanged)
â”‚       â””â”€â”€ otp_service.py      # OTP logic (unchanged)
â”œâ”€â”€ test_enhanced_notification.py  # âœ¨ NEW: Test suite
â”œâ”€â”€ ENHANCED_NOTIFICATION_API.md   # âœ¨ NEW: Complete API guide
â”œâ”€â”€ QUICK_REFERENCE.md             # âœ¨ NEW: Quick lookup
â””â”€â”€ IMPLEMENTATION_SUMMARY_ENHANCED.md  # âœ¨ NEW: Implementation details
```

---

## Summary

âœ… **Bill Generation**: Unchanged - works exactly as before
âœ… **Simple Notifications**: OTP, alerts - just body text
âœ… **Bill in Body**: Format bill details as text or HTML in email
âœ… **PDF Attachment**: Generate and attach PDF invoice when needed

ğŸ¯ **One endpoint, three modes, flexible integration!**
